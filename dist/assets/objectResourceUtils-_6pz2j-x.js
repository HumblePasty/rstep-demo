const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-DR6JRdy5.js","./index-DbqNxVxJ.js","./index-C6GyxWqK.css","./enums-D9v74xTE.js","./BufferView-a8t4LcHG.js","./resourceUtils-S8Uflk2t.js","./basicInterfaces-CZwQPxTp.js"])))=>i.map(i=>d[i]);
import{n1 as ye,lL as ne,a8 as K,mY as oe,Y as be,cy as ie,M as we,fp as le,mT as L,b as Te,lj as G,ji as ue,jh as Q,_ as ve,af as $e,ab as Re,a7 as z,di as J,dg as Me,n2 as X,e2 as Ae,aD as Be,mz as Ee,n3 as Oe,jy as Se,jz as Z,jA as Ie}from"./index-DbqNxVxJ.js";import{a as Pe}from"./devEnvironmentUtils-CnNDiFMM.js";import{C as ce,p as fe,t as k}from"./Texture-Dd2xTmd3.js";import{i as me,x as de,c as Ce,L as Fe,O as je,E as _e}from"./BufferView-a8t4LcHG.js";import{e as Ue,f as ke,l as ee,o as te}from"./vec3-JUsLf6WI.js";import{n as Le,s as re}from"./vec4-CKMFQX_R.js";import{n as Ne,d as P,o as qe,g as De,t as Ve,h as Ge}from"./DefaultMaterial_COLOR_GAMMA-CoycxM1B.js";import{r as W}from"./resourceUtils-S8Uflk2t.js";import{i as ze,f as We}from"./vec2f32-BbH2jxlN.js";import{t as He}from"./NestedMap-GuqgquCN.js";import{l as Ye}from"./Indices-95Vkthja.js";import{t as Ke}from"./requestImageUtils-CtD0Es1K.js";import{t as F}from"./orientedBoundingBox-DbvAgJju.js";import{e as H,i as R,n as Qe}from"./basicInterfaces-CZwQPxTp.js";import{e as I}from"./VertexAttribute-Cq4MnHjR.js";import{B as N,n as Je,o as Xe,s as Ze,t as et}from"./DefaultMaterial-CD2XPxQx.js";import{D as se}from"./enums-D9v74xTE.js";import{a as ae}from"./NormalAttribute.glsl-wt_R1Nd2.js";const B=()=>we.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function tt(r,t){const a=await rt(r,t),s=await it(a.textureDefinitions??{},t);let u=0;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i];u+=n!=null&&n.image?n.image.width*n.image.height*4:0}return{resource:a,textures:s,size:u+ye(a)}}async function rt(r,t){const a=t==null?void 0:t.streamDataRequester;if(a)return st(r,a,t);const s=await oe(be(r,t));if(s.ok===!0)return s.value.data;ie(s.error),pe(s.error)}async function st(r,t,a){const s=await oe(t.request(r,"json",a));if(s.ok===!0)return s.value;ie(s.error),pe(s.error.details.url)}function pe(r){throw new Te("",`Request for object resource failed: ${r}`)}function at(r){const t=r.params,a=t.topology;let s=!0;switch(t.vertexAttributes||(B().warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const n in t.vertexAttributes){const l=i[n];l!=null&&l.values?(l.valueType!=null&&l.valueType!=="UInt32"&&(B().warn(`Unsupported indexed geometry indices type '${l.valueType}', only UInt32 is currently supported`),s=!1),l.valuesPerElement!=null&&l.valuesPerElement!==1&&(B().warn(`Unsupported indexed geometry values per element '${l.valuesPerElement}', only 1 is currently supported`),s=!1)):(B().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else B().warn("Indexed geometries must specify faces"),s=!1;break}default:B().warn(`Unsupported topology '${a}'`),s=!1}r.params.material||(B().warn("Geometry requires material"),s=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(B().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function nt(r,t){var x,b;const a=new Array,s=new Array,u=new Array,i=new He,n=r.resource,l=ne.parse(n.version||"1.0","wosr");ut.validate(l);const c=n.model.name,e=n.model.geometries,o=n.materialDefinitions??{},f=r.textures;let m=0;const p=new Map;for(let d=0;d<e.length;d++){const h=e[d];if(!at(h))continue;const v=lt(h),w=h.params.vertexAttributes,j=[],q=g=>{if(h.params.topology==="PerAttributeArray")return null;const $=h.params.faces;for(const A in $)if(A===g)return $[A].values;return null},O=w[I.POSITION],U=O.values.length/O.valuesPerElement;for(const g in w){const $=w[g],A=$.values,V=q(g)??Ye(U);j.push([g,new F(A,V,$.valuesPerElement,!0)])}const M=v.texture,y=f&&f[M];if(y&&!p.has(M)){const{image:g,parameters:$}=y,A=new ce(g,$);s.push(A),p.set(M,A)}const S=p.get(M),D=S?S.id:void 0,E=v.material;let T=i.get(E,M);if(T==null){const g=o[E.slice(E.lastIndexOf("/")+1)].params;g.transparency===1&&(g.transparency=0);const $=y&&y.alphaChannelUsage,A=g.transparency>0||$==="transparency"||$==="maskAndTransparency",V=y?xe(y.alphaChannelUsage):void 0,Y={ambient:K(g.diffuse),diffuse:K(g.diffuse),opacity:1-(g.transparency||0),transparent:A,textureAlphaMode:V,textureAlphaCutoff:.33,textureId:D,initTextureTransparent:!0,doubleSided:!0,cullFace:H.None,colorMixMode:g.externalColorMixMode||"tint",textureAlphaPremultiplied:(y==null?void 0:y.parameters.preMultiplyAlpha)??!1};t!=null&&t.materialParameters&&Object.assign(Y,t.materialParameters),T=new N(Y,t),i.set(E,M,T)}u.push(T);const ge=new fe(T,j);m+=((b=(x=j.find(g=>g[0]===I.POSITION))==null?void 0:x[1])==null?void 0:b.indices.length)??0,a.push(ge)}return{engineResources:[{name:c,stageResources:{textures:s,materials:u,geometries:a},pivotOffset:n.model.pivotOffset,numberOfVertices:m,lodThreshold:null}],referenceBoundingBox:ot(a)}}function ot(r){const t=le();return r.forEach(a=>{const s=a.boundingInfo;s!=null&&(L(t,s.bbMin),L(t,s.bbMax))}),t}async function it(r,t){const a=new Array;for(const i in r){const n=r[i],l=n.images[0].data;if(!l){B().warn("Externally referenced texture data is not yet supported");continue}const c=n.encoding+";base64,"+l,e="/textureDefinitions/"+i,o=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",f={noUnpackFlip:!0,wrap:{s:se.REPEAT,t:se.REPEAT},preMultiplyAlpha:xe(o)!==R.Opaque},m=t!=null&&t.disableTextures?Promise.resolve(null):Ke(c,t);a.push(m.then(p=>({refId:e,image:p,parameters:f,alphaChannelUsage:o})))}const s=await Promise.all(a),u={};for(const i of s)u[i.refId]=i;return u}function xe(r){switch(r){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function lt(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const ut=new ne(1,2,"wosr");function _(r){if(r==null)return null;const t=r.offset!=null?r.offset:ze,a=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:We,u=G(1,0,0,0,1,0,t[0],t[1],1),i=G(Math.cos(a),-Math.sin(a),0,Math.sin(a),Math.cos(a),0,0,0,1),n=G(s[0],0,0,0,s[1],0,0,0,1),l=ue();return Q(l,i,n),Q(l,u,l),l}class ct{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class ft{constructor(t,a,s){this.name=t,this.lodThreshold=a,this.pivotOffset=s,this.stageResources=new ct,this.numberOfVertices=0}}async function mt(r,t){var f;const a=he(Pe(r));if(a.fileType==="wosr"){const m=await(t.cache?t.cache.loadWOSR(a.url,t):tt(a.url,t)),{engineResources:p,referenceBoundingBox:x}=nt(m,t);return{lods:p,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let s;if(t.cache)s=await t.cache.loadGLTF(a.url,t,!!t.usePBR);else{const{loadGLTF:m}=await ve(()=>import("./loader-DR6JRdy5.js"),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);s=await m(new Ne(t.streamDataRequester),a.url,t,t.usePBR)}const u=(f=s.model.meta)==null?void 0:f.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&u!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,gt(s,u));const n=!!t.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:Ze}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:et},c={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:o}=dt(s,l,c,t,a.specifiedLodIndex);return{lods:e,referenceBoundingBox:o,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function he(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function dt(r,t,a,s,u){const i=r.model,n=new Array,l=new Map,c=new Map,e=i.lods.length,o=le();return i.lods.forEach((f,m)=>{const p=s.skipHighLods===!0&&(e>1&&m===0||e>3&&m===1)||s.skipHighLods===!1&&u!=null&&m!==u;if(p&&m!==0)return;const x=new ft(f.name,f.lodThreshold,[0,0,0]);f.parts.forEach(b=>{const d=p?new N({},s):pt(i,b,x,t,a,l,c,s),{geometry:h,vertexCount:v}=xt(b,d??new N({},s)),w=h.boundingInfo;w!=null&&m===0&&(L(o,w.bbMin),L(o,w.bbMax)),d!=null&&(x.stageResources.geometries.push(h),x.numberOfVertices+=v)}),p||n.push(x)}),{engineResources:n,referenceBoundingBox:o}}function pt(r,t,a,s,u,i,n,l){var x,b;const c=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),e=r.materials.get(t.material),o=t.attributes.texCoord0!=null,f=t.attributes.normal!=null;if(e==null)return null;const m=ht(e.alphaMode);if(!i.has(c)){if(o){const y=(S,D=!1)=>{if(S!=null&&!n.has(S)){const E=r.textures.get(S);if(E!=null){const T=E.data;n.set(S,new ce(W(T)?T.data:T,{...E.parameters,preMultiplyAlpha:!W(T)&&D,encoding:W(T)&&T.encoding!=null?T.encoding:void 0}))}}};y(e.textureColor,m!==R.Opaque),y(e.textureNormal),y(e.textureOcclusion),y(e.textureEmissive),y(e.textureMetallicRoughness)}const d=e.color[0]**(1/P),h=e.color[1]**(1/P),v=e.color[2]**(1/P),w=e.emissiveFactor[0]**(1/P),j=e.emissiveFactor[1]**(1/P),q=e.emissiveFactor[2]**(1/P),O=e.textureColor!=null&&o?n.get(e.textureColor):null,U=Je({normalTexture:e.textureNormal,metallicRoughnessTexture:e.textureMetallicRoughness,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor,emissiveTexture:e.textureEmissive,emissiveFactor:e.emissiveFactor,occlusionTexture:e.textureOcclusion}),M=((x=e.normalTextureTransform)==null?void 0:x.scale)!=null?(b=e.normalTextureTransform)==null?void 0:b.scale:Oe;i.set(c,new N({...s,transparent:m===R.Blend,customDepthTest:Qe.Lequal,textureAlphaMode:m,textureAlphaCutoff:e.alphaCutoff,diffuse:[d,h,v],ambient:[d,h,v],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?H.None:H.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:f?ae.Attribute:ae.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:O!=null?O.id:void 0,colorMixMode:e.colorMixMode,normalTextureId:e.textureNormal!=null&&o?n.get(e.textureNormal).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.textureOcclusion!=null&&o?n.get(e.textureOcclusion).id:void 0,emissiveTextureId:e.textureEmissive!=null&&o?n.get(e.textureEmissive).id:void 0,metallicRoughnessTextureId:e.textureMetallicRoughness!=null&&o?n.get(e.textureMetallicRoughness).id:void 0,emissiveFactor:[w,j,q],mrrFactors:U?Xe:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:U,colorTextureTransformMatrix:_(e.colorTextureTransform),normalTextureTransformMatrix:_(e.normalTextureTransform),scale:[M[0],M[1]],occlusionTextureTransformMatrix:_(e.occlusionTextureTransform),emissiveTextureTransformMatrix:_(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_(e.metallicRoughnessTextureTransform),...u},l))}const p=i.get(c);if(a.stageResources.materials.push(p),o){const d=h=>{h!=null&&a.stageResources.textures.push(n.get(h))};d(e.textureColor),d(e.textureNormal),d(e.textureOcclusion),d(e.textureEmissive),d(e.textureMetallicRoughness)}return p}function xt(r,t){const a=r.attributes.position.count,s=qe(r.indices||a,r.primitiveType),u=k(3*a),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;Ue(u,i,r.transform,3,n);const l=[[I.POSITION,new F(u,s,3,!0)]];if(r.attributes.normal!=null){const e=k(3*a),{typedBuffer:o,typedBufferStride:f}=r.attributes.normal;Se(C,r.transform),ke(e,o,C,3,f),Z(C)&&ee(e,e),l.push([I.NORMAL,new F(e,s,3,!0)])}if(r.attributes.tangent!=null){const e=k(4*a),{typedBuffer:o,typedBufferStride:f}=r.attributes.tangent;Ie(C,r.transform),Le(e,o,C,4,f),Z(C)&&ee(e,e,4),l.push([I.TANGENT,new F(e,s,4,!0)])}if(r.attributes.texCoord0!=null){const e=k(2*a),{typedBuffer:o,typedBufferStride:f}=r.attributes.texCoord0;De(e,o,2,f),l.push([I.UV0,new F(e,s,2,!0)])}const c=r.attributes.color;if(c!=null){const e=new Uint8Array(4*a);c.elementCount===4?c instanceof Ce?re(e,c,255):c instanceof de?Ve(e,c):c instanceof Fe&&re(e,c,1/256):(e.fill(255),c instanceof me?te(e,c.typedBuffer,255,4,c.typedBufferStride):r.attributes.color instanceof je?Ge(e,c.typedBuffer,4,r.attributes.color.typedBufferStride):r.attributes.color instanceof _e&&te(e,c.typedBuffer,1/256,4,c.typedBufferStride)),l.push([I.COLOR,new F(e,s,4,!0)])}return{geometry:new fe(t,l),vertexCount:a}}const C=ue();function ht(r){switch(r){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function gt(r,t){for(let a=0;a<r.model.lods.length;++a){const s=r.model.lods[a];for(const u of s.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,l=n.count,c=z(),e=z(),o=z(),f=new Uint8Array(4*l),m=new Float64Array(3*l),p=$e(Re(),u.transform);let x=0,b=0;for(let d=0;d<l;d++){n.getVec(d,e),i.getVec(d,c),J(e,e,u.transform),Me(o,e,t.center),X(o,o,t.radius);const h=o[2],v=Ae(o),w=Math.min(.45+.55*v*v,1);X(o,o,t.radius),p!==null&&J(o,o,p),Be(o,o),a+1!==r.model.lods.length&&r.model.lods.length>1&&Ee(o,o,c,h>-1?.2:Math.min(-4*h-3.8,1)),m[x]=o[0],m[x+1]=o[1],m[x+2]=o[2],x+=3,f[b]=255*w,f[b+1]=255*w,f[b+2]=255*w,f[b+3]=255,b+=4}u.attributes.normal=new me(m),u.attributes.color=new de(f)}}}const _t=Object.freeze(Object.defineProperty({__proto__:null,fetch:mt,parseUrl:he},Symbol.toStringTag,{value:"Module"}));export{mt as e,_t as o,_ as s};
