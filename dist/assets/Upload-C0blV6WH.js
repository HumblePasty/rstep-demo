import{bZ as g,fk as m,T as u,s as v,Z as _,hs as w,ah as T,ht as k,fP as R,bm as b,eZ as x,r as l,m as n,n as F}from"./index-CdlB_1jZ.js";import{i as S,e as P,h as E}from"./progressUtils-D6ulQ9Xu.js";import{o as j}from"./infoFor3D-BU6V8avP.js";let i=class extends g{constructor(){super({}),this.files=[],this.progress=0,this._uploadTask=null,this._layer=null}destroy(){this.cancel(),this.files=[],this._layer=null,this._uploadTask=null}get state(){const e=this._uploadTask;return e&&this.files.length!==0?e.finished?e.error?"error":"success":"pending":"default"}get result(){var e;return((e=this._uploadTask)==null?void 0:e.value)??null}get error(){var e;return((e=this._uploadTask)==null?void 0:e.error)??null}uploadTo(e){this.cancel(),this.files=[],this._layer=e,this._uploadTask=m(async s=>{var d;const o=await z(e);u(s),this.progress=0,this.files=o;const t=S(P.upload,f=>{this.progress=f},"Upload.uploadTo");if(o.length===0)return null;u(s);const a=await e.extractAndFilterFiles(o);u(s),a.length>0&&(this.files=a);const r=await e.convertMesh(a,{signal:s,onProgress:t.makeOnProgress("createFromFiles")});if(u(s),!r)throw new v("editor:upload","could not upload or convert model");const p=a.reduce((f,y)=>f+y.size,0),h=t.simulate("loadMesh",E(p));try{await r.load()}finally{h.remove()}if(_("enable-feature:georeferenced-uploads")&&r.metadata.georeferenced){if(await w(e.spatialReference,(d=r.origin)==null?void 0:d.spatialReference))return{type:"georeferenced",mesh:r};if((e.spatialReference.isWebMercator||e.spatialReference.isWGS84)&&await M(r,e.spatialReference))return{type:"georeferenced-reprojected",mesh:r}}return r.spatialReference=e.spatialReference,r.vertexSpace.origin=[0,0,0],{type:"non-georeferenced",mesh:r}})}retry(){this._layer&&this.uploadTo(this._layer)}cancel(){var e;(e=this._uploadTask)==null||e.abort()}};l([n()],i.prototype,"files",void 0),l([n()],i.prototype,"progress",void 0),l([n()],i.prototype,"state",null),l([n()],i.prototype,"result",null),l([n()],i.prototype,"error",null),l([n()],i.prototype,"_uploadTask",void 0),l([n()],i.prototype,"_layer",void 0),i=l([F("esri.widgets.Editor.Upload")],i);let c=null;async function z(e){const{resolve:s,promise:o}=T(),t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=[...j(e.infoFor3D),".zip"].join(","),t.style.display="none",document.body.appendChild(t);const a=k(t,"change",()=>s(t.files?Array.from(t.files):[]));return c?c(t):t.click(),o.finally(()=>{a.remove(),t.remove()})}function D(e,s){c=o=>{s==null||s(),Promise.resolve().then(()=>e).then(t=>{if(!c)return;const a=new DataTransfer;t.forEach(r=>a.items.add(r)),o.files=a.files,o.dispatchEvent(new Event("change"))})}}function G(){c=null}async function M(e,s){if(await R(e.spatialReference,s),!e.vertexSpace.origin)return!1;const[o,t,a]=e.vertexSpace.origin,r=new b({x:o,y:t,z:a,spatialReference:e.spatialReference}),p=x(r,s);return!!p&&(e.vertexSpace.origin=[p.x,p.y,p.z??0],e.spatialReference=s,!0)}export{i as Upload,G as clearPromptForFilesStub,D as stubFilePickerToSelect};
