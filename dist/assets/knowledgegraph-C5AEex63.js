const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./knowledgeGraphService-Vhk4n9tE.js","./index-BlU5-B7d.js","./index-DP_G0skH.css","./GraphQueryStreaming-YgjJ8TuW.js"])))=>i.map(i=>d[i]);
import{z as I,_ as F,S as J,iw as P,hF as Q,ax as V,d7 as j,de as K,d6 as M,b8 as T,iy as z}from"./index-BlU5-B7d.js";import{t as B,N as b}from"./arcadeUtils-KvcgB8BX.js";import{i as W,a as p,r as f,d as k,P as y,$ as C,Y as L,E as _,B as O,z as G,k as D,t as U,g as Y,T as Z,Z as q,_ as H}from"./languageUtils-C_NISTr5.js";import{l as X}from"./portalUtils-B8VmXi8r.js";import{p as $,n as tt}from"./project-BSjR502S.js";import{s as et,m as nt,t as rt,p as at,c as it}from"./GraphQueryStreaming-YgjJ8TuW.js";import"./TimeOnly-BlBMiTev.js";import"./ImmutableArray-BPVd6ESQ.js";import"./number-BrDV2K-3.js";import"./shared-BQrPGA7v.js";let c=null;async function ot(t){const e=V.geometryServiceUrl??"";if(!e){j()||await K();for(const n of t)n.container[n.indexer]=M(n.container[n.indexer],T.WGS84);return}const r=t.map(n=>n.container[n.indexer]),i=new $({geometries:r,outSpatialReference:T.WGS84}),s=await tt(e,i);for(let n=0;n<s.length;n++){const a=t[n];a.container[a.indexer]=s[n]}}async function E(t,e){const r=new J({portal:t,id:e});return await r.load(),c===null&&(c=await F(()=>import("./knowledgeGraphService-Vhk4n9tE.js").then(i=>i.k),__vite__mapDeps([0,1,2,3]),import.meta.url)),await c.fetchKnowledgeGraph(r.url)}function v(t,e,r,i,s){if(t===null)return null;if(y(t)||G(t))return t;if(D(t)||D(t))return t.toJSDate();if(U(t))return t.toStorageFormat();if(Y(t))return t.toStorageString();if(Z(t)){const n={};for(const a of t.keys())n[a]=v(t.field(a),e,r,i,s),n[a]instanceof P&&s.push({container:n,indexer:a});return n}if(_(t)){const n=t.map(a=>v(a,e,r,i,s));for(let a=0;a<n.length;a++)n[a]instanceof P&&s.push({container:n,indexer:a});return n}return q(t)?t.spatialReference.isWGS84?t:t.spatialReference.isWebMercator&&e?Q(t):t:void 0}function st(t,e){if(!t)return t;if(t.spatialReference.isWGS84&&e.spatialReference.isWebMercator)return z(t);if(t.spatialReference.equals(e.spatialReference))return t;throw new p(e,f.WrongSpatialReference,null)}function R(t,e){if(!t)return null;const r={};for(const i in t)r[i]=g(t[i],e);return r}function g(t,e){return t===null?null:_(t)?t.map(r=>g(r,e)):t instanceof nt?{graphTypeName:t.typeName,id:t.id,graphType:"entity",properties:R(t.properties,e)}:t instanceof rt?{graphType:"object",properties:R(t.properties,e)}:t instanceof at?{graphTypeName:t.typeName,id:t.id,graphType:"relationship",originId:t.originId??null,destinationId:t.destinationId??null,properties:R(t.properties,e)}:t instanceof it?{graphType:"path",path:t.path?t.path.map(r=>g(r,e)):null}:q(t)?st(t,e):y(t)||G(t)||H(t)?t:null}function yt(t){t.mode==="async"&&(t.functions.knowledgegraphbyportalitem=function(e,r){return t.standardFunctionAsync(e,r,(i,s,n)=>{var m,d;if(W(n,2,2,e,r),n[0]===null)throw new p(e,f.PortalRequired,r);if(n[0]instanceof B){const u=k(n[1]);let h;return h=(m=e.services)!=null&&m.portal?e.services.portal:I.getDefault(),E(X(n[0],h),u)}if(y(n[0])===!1)throw new p(e,f.InvalidParameter,r);const a=k(n[0]);return E(((d=e.services)==null?void 0:d.portal)??I.getDefault(),a)})},t.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),t.functions.querygraph=function(e,r){return t.standardFunctionAsync(e,r,async(i,s,n)=>{var x;W(n,2,4,e,r);const a=n[0];if(!C(a))throw new p(e,f.InvalidParameter,r);const m=n[1];if(!y(m))throw new p(e,f.InvalidParameter,r);c===null&&(c=await F(()=>import("./knowledgeGraphService-Vhk4n9tE.js").then(o=>o.k),__vite__mapDeps([0,1,2,3]),import.meta.url));let d=null;const u=L(n[2],null);if(!(u instanceof b||u===null))throw new p(e,f.InvalidParameter,r);if(u){let o=[];d=v(u,!0,!1,e,o),o=o.filter(l=>!l.container[l.indexer].spatialReference.isWGS84),o.length>0&&await ot(o)}const h=new et({openCypherQuery:m,bindParameters:d});(((x=a==null?void 0:a.serviceDefinition)==null?void 0:x.currentVersion)??11.3)>11.2&&(h.outputSpatialReference=e.spatialReference);const A=(await c.executeQueryStreaming(a,h)).resultRowsStream.getReader(),S=[];try{for(;;){const{done:o,value:l}=await A.read();if(o)break;if(_(l))for(const w of l)S.push(g(w,e));else{const w=[];for(const N of l)w.push(g(l[N],e));S.push(w)}}}catch(o){throw o}return b.convertJsonToArcade(S,O(e),!1,!0)})},t.signatures.push({name:"querygraph",min:2,max:4}))}export{yt as registerFunctions};
