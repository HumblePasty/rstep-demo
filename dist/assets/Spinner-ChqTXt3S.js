const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./calcite-icon-CghSChHP.js","./index-DbqNxVxJ.js","./index-C6GyxWqK.css"])))=>i.map(i=>d[i]);
import{bZ as fe,ak as R,k as q,gS as K,b,lR as ee,r,o,t as ge,al as be,p as L,iH as Me,i8 as _e,gR as te,i9 as qe,_ as ke,bG as d,bI as m,pc as ie,pd as se,pe as ae,ic as ne,pf as Y,pg as re,ph as xe,pi as ve,bJ as oe,pj as Le,pk as Pe,pl as Oe,F as we,iY as Ee,pm as Te,bb as le,bP as je,pn as Re,M as Be,cO as De,cP as Ve,kC as Q,i2 as U,kv as de,c0 as Se,i6 as Ne,eA as ze,iq as He}from"./index-DbqNxVxJ.js";import{T as Qe}from"./unitFormatUtils-z53RvnR8.js";import{a as Ue}from"./AttachmentInfo-Dw8IZgKx.js";import{a as Ge,M as Ze,F as We}from"./featureUtils-29JQ2bLG.js";import{i as P}from"./legacyIcon-DkTFV6vi.js";import{$ as Je}from"./utils-olNgSvwH.js";const ce={editing:!1,operations:{add:!0,update:!0,delete:!0}},Ae=R.ofType(Ue);let w=class extends fe{constructor(t){super(t),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities={...ce},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new Ae,this.fileInfos=new R,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(q(()=>this.graphic,()=>this._graphicChanged(),K))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(t){return{...ce,...t}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:t}=this;if(!t)return!1;const e=t.layer||t.sourceLayer;return(e==null?void 0:e.loaded)&&"capabilities"in e&&e.capabilities&&"operations"in e.capabilities&&"supportsResizeAttachments"in e.capabilities.operations&&e.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:t,attachmentInfos:e}=this;if(!t||typeof t.queryAttachments!="function")throw new b("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId();if(typeof i!="number")throw new b("invalid-object-id","getAttachments(): Numeric object id is required");const s=new ee({objectIds:[i],returnMetadata:!0}),a=[],n=t.queryAttachments(s).then(u=>u[i]||a).catch(()=>a);this._getAttachmentsPromise=n,this.notifyChange("state");const l=await n;return e.destroyAll(),l.length&&e.addMany(l),this._getAttachmentsPromise=null,this.notifyChange("state"),l}async addAttachment(t,e=this.graphic){var u;const{_attachmentLayer:i,attachmentInfos:s,capabilities:a}=this;if(!e)throw new b("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:e});if(!t)throw new b("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!((u=a.operations)!=null&&u.add))throw new b("invalid-capabilities","addAttachment(): add capabilities are required.");if(!i||typeof i.addAttachment!="function")throw new b("invalid-layer","addAttachment(): A valid layer is required.");const n=i.addAttachment(e,t).then(h=>this._queryAttachment(h.objectId,e)),l=await n;return s.add(l),l}async deleteAttachment(t){var u;const{_attachmentLayer:e,attachmentInfos:i,graphic:s,capabilities:a}=this;if(!t)throw new b("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!((u=a.operations)!=null&&u.delete))throw new b("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!e||typeof e.deleteAttachments!="function")throw new b("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new b("invalid-graphic","deleteAttachment(): A graphic is required.");const n=e.deleteAttachments(s,[t.id]).then(()=>t),l=await n;return i.remove(l),l.destroy(),l}async updateAttachment(t,e=this.activeAttachmentInfo){var f;const{_attachmentLayer:i,attachmentInfos:s,graphic:a,capabilities:n}=this;if(!t)throw new b("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new b("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!((f=n.operations)!=null&&f.update))throw new b("invalid-capabilities","updateAttachment(): Update capabilities are required.");const l=s.indexOf(e);if(!i||typeof i.updateAttachment!="function")throw new b("invalid-layer","updateAttachment(): A valid layer is required.");if(!a)throw new b("invalid-graphic","updateAttachment(): A graphic is required.");const u=i.updateAttachment(a,e.id,t).then(g=>this._queryAttachment(g.objectId)),h=await u;return s.splice(l,1,h),h}async commitFiles(){return await Promise.all(this.fileInfos.items.map(t=>this.addAttachment(t.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(t,e){if(!t||!e)return null;const i={file:t,form:e};return this.fileInfos.add(i),i}updateFile(t,e,i=this.activeFileInfo){if(!t||!e||!i)return null;const s=this.fileInfos.indexOf(i);return s>-1&&this.fileInfos.splice(s,1,{file:t,form:e}),this.fileInfos.items[s]}deleteFile(t){const e=this.fileInfos.find(i=>i.file===t);return e?(this.fileInfos.remove(e),e):null}async _queryAttachment(t,e){const{_attachmentLayer:i}=this;if(!t||!(i!=null&&i.queryAttachments))throw new b("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(e);if(typeof s!="number")throw new b("invalid-object-id","getAttachments(): Numeric object id is required");const a=new ee({objectIds:[s],attachmentsWhere:`AttachmentId=${t}`,returnMetadata:!0});return i.queryAttachments(a).then(n=>n[s][0])}_getObjectId(t=this.graphic){return(t==null?void 0:t.getObjectId())??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>this.attachmentInfos.destroyAll()))}_setAttachmentLayer(){const{graphic:t}=this,e=Ge(t);this._attachmentLayer=e?e.type==="scene"&&e.associatedLayer!=null?e.associatedLayer:e:null}};r([o()],w.prototype,"capabilities",void 0),r([ge("capabilities")],w.prototype,"castCapabilities",null),r([o()],w.prototype,"activeAttachmentInfo",void 0),r([o()],w.prototype,"activeFileInfo",void 0),r([o({readOnly:!0,type:Ae})],w.prototype,"attachmentInfos",void 0),r([o()],w.prototype,"fileInfos",void 0),r([o({type:be})],w.prototype,"graphic",void 0),r([o()],w.prototype,"mode",void 0),r([o({readOnly:!0})],w.prototype,"state",null),r([o()],w.prototype,"filesEnabled",void 0),r([o({readOnly:!0})],w.prototype,"supportsResizeAttachments",null),w=r([L("esri.widgets.Attachments.AttachmentsViewModel")],w);const Fe=w;function ue(t){const e=t.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function Ye(t){const e=Me("esri/themes/base/images/files/");return t?t==="text/plain"?`${e}text-32.svg`:t==="application/pdf"?`${e}pdf-32.svg`:t==="text/csv"?`${e}csv-32.svg`:t==="application/gpx+xml"?`${e}gpx-32.svg`:t==="application/x-dwf"?`${e}cad-32.svg`:t==="application/postscript"||t==="application/json"||t==="text/xml"||t==="model/vrml"?`${e}code-32.svg`:t==="application/x-zip-compressed"||t==="application/x-7z-compressed"||t==="application/x-gzip"||t==="application/x-tar"||t==="application/x-gtar"||t==="application/x-bzip2"||t==="application/gzip"||t==="application/x-compress"||t==="application/x-apple-diskimage"||t==="application/x-rar-compressed"||t==="application/zip"?`${e}zip-32.svg`:t.includes("image/")?`${e}image-32.svg`:t.includes("audio/")?`${e}sound-32.svg`:t.includes("video/")?`${e}video-32.svg`:t.includes("msexcel")||t.includes("ms-excel")||t.includes("spreadsheetml")?`${e}excel-32.svg`:t.includes("msword")||t.includes("ms-word")||t.includes("wordprocessingml")?`${e}word-32.svg`:t.includes("powerpoint")||t.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}const he={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},p="esri-attachments",c={base:p,loaderContainer:`${p}__loader-container`,loader:`${p}__loader`,container:`${p}__container`,containerList:`${p}__container--list`,containerPreview:`${p}__container--preview`,actions:`${p}__actions`,deleteButton:`${p}__delete-button`,addAttachmentButton:`${p}__add-attachment-button`,errorMessage:`${p}__error-message`,items:`${p}__items`,item:`${p}__item`,itemButton:`${p}__item-button`,itemMask:`${p}__item-mask`,itemMaskIcon:`${p}__item-mask--icon`,itemImage:`${p}__image`,itemImageResizable:`${p}__image--resizable`,itemLabel:`${p}__label`,itemFilename:`${p}__filename`,itemChevronIcon:`${p}__item-chevron-icon`,itemLink:`${p}__item-link`,itemLinkOverlay:`${p}__item-link-overlay`,itemLinkOverlayIcon:`${p}__item-link-overlay-icon`,itemAddIcon:`${p}__item-add-icon`,formNode:`${p}__form-node`,fileFieldset:`${p}__file-fieldset`,fileLabel:`${p}__file-label`,fileName:`${p}__file-name`,fileInput:`${p}__file-input`,metadata:`${p}__metadata`,metadataFieldset:`${p}__metadata-fieldset`,progressBar:`${p}__progress-bar`},G=window.CSS;let _=class extends _e{constructor(e,i){super(e,i),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...he},this._supportsImageOrientation=G&&G.supports&&G.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}normalizeCtorArgs(e){return e!=null&&e.viewModel||(e={viewModel:new Fe,...e}),e}initialize(){this.addHandles([te(()=>{var e;return(e=this.viewModel)==null?void 0:e.attachmentInfos},"change",()=>this.scheduleRender()),te(()=>{var e;return(e=this.viewModel)==null?void 0:e.fileInfos},"change",()=>this.scheduleRender()),q(()=>{var e;return(e=this.viewModel)==null?void 0:e.mode},()=>this._modeChanged(),K)])}loadDependencies(){return qe({icon:()=>ke(()=>import("./calcite-icon-CghSChHP.js"),__vite__mapDeps([0,1,2]),import.meta.url)})}get capabilities(){return this.viewModel.capabilities}set capabilities(e){this.viewModel.capabilities=e}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get icon(){return"attachment"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}castVisibleElements(e){return{...he,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:i}=this;return this._set("submitting",!0),this._set("error",null),i.addAttachment(e).then(s=>(this._set("submitting",!1),this._set("error",null),i.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new b("attachments:add-attachment",this.messages.addErrorMessage,s)),s})}deleteAttachment(e){const{viewModel:i}=this;return this._set("submitting",!0),this._set("error",null),i.deleteAttachment(e).then(s=>(this._set("submitting",!1),this._set("error",null),i.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new b("attachments:delete-attachment",this.messages.deleteErrorMessage,s)),s})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:i}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(i).then(s=>(this._set("submitting",!1),this._set("error",null),e.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new b("attachments:update-attachment",this.messages.updateErrorMessage,s)),s})}addFile(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e}updateFile(){const{viewModel:e}=this,i=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",i}deleteFile(e){var s;const i=this.viewModel.deleteFile(e||((s=this.viewModel.activeFileInfo)==null?void 0:s.file));return this.viewModel.mode="view",i}render(){const{submitting:e,viewModel:i}=this,{state:s}=i;return d("div",{class:this.classes(c.base,m.widget)},e?this._renderProgressBar():null,s==="loading"?this._renderLoading():this._renderAttachments(),this._renderErrorMessage())}_renderErrorMessage(){const{error:e,visibleElements:i}=this;return e&&i.errorMessage?d("div",{class:c.errorMessage,key:"error-message"},e.message):null}_renderAttachments(){const{activeFileInfo:e,mode:i,activeAttachmentInfo:s}=this.viewModel;return i==="add"?this._renderAddForm():i==="edit"?this._renderDetailsForm(s||e):this._renderAttachmentContainer()}_renderLoading(){return d("div",{class:c.loaderContainer,key:"loader"},d("div",{class:c.loader}))}_renderProgressBar(){return this.visibleElements.progressBar?d("div",{class:c.progressBar,key:"progress-bar"}):null}_renderAddForm(){const{submitting:e,selectedFile:i}=this,s=e||!i,a=this.visibleElements.cancelAddButton?d("button",{bind:this,class:this.classes(m.button,m.buttonTertiary,m.buttonSmall,m.buttonHalf,e&&m.buttonDisabled),disabled:e,onclick:this._cancelForm,type:"button"},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?d("button",{class:this.classes(m.button,m.buttonSecondary,m.buttonSmall,m.buttonHalf,{[m.buttonDisabled]:s}),disabled:s,type:"submit"},this.messages.add):null,l=i?d("span",{class:c.fileName,key:"file-name"},i.name):null,u=d("form",{afterCreate:se,afterRemoved:ie,bind:this,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},d("fieldset",{class:c.fileFieldset},l,d("label",{class:this.classes(c.fileLabel,m.button,m.buttonSecondary)},i?this.messages.changeFile:this.messages.selectFile,d("input",{bind:this,class:c.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))),n,a);return d("div",{class:c.formNode,key:"add-form-container"},u)}_renderDetailsForm(e){var O,E,T;const{visibleElements:i,viewModel:s,selectedFile:a,submitting:n}=this,{capabilities:l}=s,u=n||!a;let h,f,g,v;a?(h=a.type,f=a.name,g=a.size):e&&"file"in e?(h=e.file.type,f=e.file.name,g=e.file.size):e&&"contentType"in e&&(h=e.contentType,f=e.name,g=e.size,v=e.url);const A=l.editing&&((O=l.operations)!=null&&O.delete)&&i.deleteButton?d("button",{bind:this,class:this.classes(m.button,m.buttonSmall,m.buttonTertiary,c.deleteButton,{[m.buttonDisabled]:n}),disabled:n,key:"delete-button",onclick:x=>this._submitDeleteAttachment(x,e),type:"button"},this.messages.delete):void 0,F=l.editing&&((E=l.operations)!=null&&E.update)&&i.updateButton?d("button",{class:this.classes(m.button,m.buttonSmall,m.buttonThird,{[m.buttonDisabled]:u}),disabled:u,key:"update-button",type:"submit"},this.messages.update):void 0,k=this.visibleElements.cancelUpdateButton?d("button",{bind:this,class:this.classes(m.button,m.buttonSmall,m.buttonTertiary,m.buttonThird,{[m.buttonDisabled]:n}),disabled:n,key:"cancel-button",onclick:this._cancelForm,type:"button"},this.messages.cancel):void 0,I=l.editing&&((T=l.operations)!=null&&T.update)?d("fieldset",{class:c.fileFieldset,key:"file"},d("span",{class:c.fileName,key:"file-name"},f),d("label",{class:this.classes(c.fileLabel,m.button,m.buttonSecondary)},this.messages.changeFile,d("input",{bind:this,class:c.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))):void 0,S=d("fieldset",{class:c.metadataFieldset,key:"size"},d("label",null,Qe(this.messagesUnits,g??0))),N=d("fieldset",{class:c.metadataFieldset,key:"content-type"},d("label",null,h)),z=v!=null?d("a",{class:c.itemLink,href:v,rel:"noreferrer",target:"_blank"},this._renderImageMask(e,400),d("div",{class:c.itemLinkOverlay},d("span",{class:c.itemLinkOverlayIcon},d("calcite-icon",{icon:"launch"})))):this._renderImageMask(e,400),H=d("form",{afterCreate:se,afterRemoved:ie,bind:this,"data-node-ref":"_updateAttachmentForm",onsubmit:x=>this._submitUpdateAttachment(x,e)},d("div",{class:c.metadata},S,N),I,d("div",{class:c.actions},A,k,F));return d("div",{class:c.formNode,key:"edit-form-container"},z,H)}_renderImageMask(e,i){return e?"file"in e?this._renderGenericImageMask(e.file.name,e.file.type):this._renderImageMaskForAttachment(e,i):null}_renderGenericImageMask(e,i){const{supportsResizeAttachments:s}=this.viewModel,a=Ye(i),n={[c.itemImageResizable]:s};return d("div",{class:this.classes(c.itemMaskIcon,c.itemMask),key:a},d("img",{alt:e,class:this.classes(n,c.itemImage),src:a,title:e}))}_renderImageMaskForAttachment(e,i){const{supportsResizeAttachments:s}=this.viewModel;if(!e)return null;const{contentType:a,name:n,url:l}=e;if(!s||!ue(a))return this._renderGenericImageMask(n,a);const u=this._getCSSTransform(e),h=u?{transform:u,"image-orientation":"none"}:{},f=`${l}${l!=null&&l.includes("?")?"&":"?"}w=${i}`,g={[c.itemImageResizable]:s};return d("div",{class:this.classes(c.itemMask),key:f},d("img",{alt:n,class:this.classes(g,c.itemImage),src:f,styles:h,title:n}))}_renderFile(e){const{file:i}=e;return d("li",{class:c.item,key:i},d("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:c.itemButton,key:"details-button",onclick:()=>this._startEditFile(e),title:this.messages.attachmentDetails,type:"button"},this._renderImageMask(e),d("label",{class:c.itemLabel},d("span",{class:c.itemFilename},i.name||this.messages.noTitle),d("span",{"aria-hidden":"true",class:this.classes(c.itemChevronIcon,ae(this.container)?P.left:P.right)}))))}_renderAttachmentInfo({attachmentInfo:e,displayType:i}){const{viewModel:s,effectiveDisplayType:a}=this,{capabilities:n,supportsResizeAttachments:l}=s,{contentType:u,name:h,url:f}=e,g=this._renderImageMask(e,i==="list"?48:400),v=n.editing?d("span",{"aria-hidden":"true",class:this.classes(c.itemChevronIcon,ae(this.container)?P.left:P.right)}):null,A=[g,a==="preview"&&l&&ue(u)?null:d("label",{class:c.itemLabel},d("span",{class:c.itemFilename},h||this.messages.noTitle),v)],F=n.editing?d("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:c.itemButton,"data-attachment-info-id":e.id,key:"details-button",onclick:()=>this._startEditAttachment(e),title:this.messages.attachmentDetails,type:"button"},A):d("a",{class:c.itemButton,href:f??void 0,key:"details-link",rel:"noreferrer",target:"_blank"},A);return d("li",{class:c.item,key:e},F)}_renderAttachmentContainer(){var k;const{effectiveDisplayType:e,viewModel:i,visibleElements:s}=this,{attachmentInfos:a,capabilities:n,fileInfos:l}=i,u=!!(a!=null&&a.length),h=!!(l!=null&&l.length),f={[c.containerList]:e!=="preview",[c.containerPreview]:e==="preview"},g=n.editing&&((k=n.operations)!=null&&k.add)&&s.addButton?d("button",{bind:this,class:this.classes(m.button,m.buttonTertiary,c.addAttachmentButton),onclick:()=>this._startAddAttachment(),type:"button"},d("span",{"aria-hidden":"true",class:this.classes(c.itemAddIcon,P.plus)}),this.messages.add):void 0,v=u?d("ul",{class:c.items,key:"attachments-list"},a.toArray().map(I=>this._renderAttachmentInfo({attachmentInfo:I,displayType:e}))):void 0,A=h?d("ul",{class:c.items,key:"file-list"},l.toArray().map(I=>this._renderFile(I))):void 0,F=h||u?void 0:d("div",{class:m.empty},this.messages.noAttachments);return d("div",{class:this.classes(c.container,f),key:"attachments-container"},v,A,F,g)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){var a;const i=e.target,s=(a=i.files)==null?void 0:a.item(0);this._set("selectedFile",s)}_submitDeleteAttachment(e,i){e.preventDefault(),i&&("file"in i?this.deleteFile(i.file):i&&this.deleteAttachment(i))}_submitAddAttachment(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(e,i){e.preventDefault(),i&&"file"in i?this.updateFile():this.updateAttachment()}_startEditAttachment(e){const{viewModel:i}=this;i.activeFileInfo=null,i.activeAttachmentInfo=e,i.mode="edit"}_startEditFile(e){const{viewModel:i}=this;i.activeAttachmentInfo=null,i.activeFileInfo=e,i.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e){const{orientationInfo:i}=e;return!this._supportsImageOrientation&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};r([o()],_.prototype,"capabilities",null),r([o()],_.prototype,"displayType",void 0),r([o({readOnly:!0})],_.prototype,"effectiveDisplayType",null),r([o()],_.prototype,"graphic",null),r([o()],_.prototype,"icon",null),r([o()],_.prototype,"label",null),r([o(),ne("esri/widgets/Attachments/t9n/Attachments")],_.prototype,"messages",void 0),r([o(),ne("esri/core/t9n/Units")],_.prototype,"messagesUnits",void 0),r([o({readOnly:!0})],_.prototype,"selectedFile",void 0),r([o({readOnly:!0})],_.prototype,"submitting",void 0),r([o({readOnly:!0})],_.prototype,"error",void 0),r([o({type:Fe})],_.prototype,"viewModel",void 0),r([o()],_.prototype,"visibleElements",void 0),r([ge("visibleElements")],_.prototype,"castVisibleElements",null),_=r([L("esri.widgets.Attachments")],_);const mt=_,Ke=t=>(t==null?void 0:t.type)==="field",Ie=t=>(t==null?void 0:t.type)==="group",Xe=t=>(t==null?void 0:t.type)==="relationship",yt=t=>t.type==="text",ft=t=>!Ie(t)&&t.group!=null,$e=t=>t.reduce((e,i)=>Ie(i)?[...e,...i.inputs]:[...e,i],[]),gt=t=>$e(t).filter(Ke),bt=t=>$e(t).filter(Xe),_t=t=>t!=null&&(B(t,"combo-box")||B(t,"radio-buttons")),B=(t,e)=>{var i;return t!=null&&((i=t.input)==null?void 0:i.type)===e},vt=t=>t!=null&&(B(t,"text-box")||B(t,"text-area")),wt=({domain:t,inputType:e="text-box",dataType:i})=>i==="number"&&e==="text-box"&&(!t||t.type!=="coded-value");function At(t){const{attributes:e,fieldsIndex:i,label:s,timeZone:a}=t;if(!e||typeof e!="object")return s;const n=Object.keys(e).filter(h=>Y(s,h)),l=n.map(h=>e[h]),u=n.map(h=>i.get(h)).filter(we);return st(s,it({values:l,fields:u,timeZone:a}))}const D="expression/",et="expr/",tt="field/";function Ft(t){const[e,i]=t.split(D);return e===""&&i?i:(Be.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${t} is not a valid expression reference of the form '${D}/expressionName'`),"")}function It(t){return`${D}${t}`}function $t(t){return`${tt}${t}`}function Ct(t){return t.startsWith(D)}function Mt(t){return t.startsWith(et)}function it(t){const{fields:e,values:i}=t,s=t.timeZone??void 0,a=e.map((n,l)=>{let u=i[l];if(n.domain&&n.domain.type==="coded-value"){const h=n.domain.codedValues.find(f=>f.code===u);h!=null&&h.name&&(u=h.name)}return(Je(n)||je(n))&&(u=Re(n,u,{timeZone:s,...ve(n)})),[n.name,u]});return Object.fromEntries(a)}function st(t,e){return le(le(t,i=>`{${i.toLowerCase()}}`),Object.fromEntries(Object.entries(e).map(([i,s])=>[i.toLowerCase(),s])))}const qt=t=>{var i,s,a,n;const e={typeFieldName:null,types:[]};return t&&(t.type==="subtype-sublayer"?(e.typeFieldName=(i=t.parent)==null?void 0:i.subtypeField,e.types=((s=t.parent)==null?void 0:s.subtypes)??[]):t.type==="subtype-group"||t.type==="feature"&&((a=t.subtypes)!=null&&a.length)?(e.typeFieldName=t.subtypeField,e.types=t.subtypes??[]):"types"in t&&t.types&&(e.typeFieldName=t.typeIdField,e.types=t.types.map(({id:l,name:u,domains:h})=>({code:l,name:u,domains:h}))),e.typeFieldName!=null&&(e.typeFieldName=((n=t.getField(e.typeFieldName))==null?void 0:n.name)??e.typeFieldName)),e};var V;(function(t){t.TOO_SHORT="length-validation-error::too-short",t.TOO_LONG="length-validation-error::too-long"})(V||(V={}));const pe={type:"number"},me={type:"number",intlOptions:{notation:"scientific"}};function ye(t){return t>=1e7||t<=-1e7}function at(t,{validationErrors:e}){return t.max!=null&&t.min!=null?e.outsideRange:t.max!=null?e.outsideRangeMax:e.outsideRangeMin}const kt=(t,e,i)=>{const{dataType:s,error:a,minLength:n,value:l,required:u}=t,h=e==null?void 0:e.validationErrors;if(!h||!a)return null;if(u&&l===null)return h.cannotBeNull;if(a===re.VALUE_OUT_OF_RANGE||a===xe.OUT_OF_RANGE){const{field:f,range:g}=t,v={type:"date",intlOptions:{timeZone:f.type==="date"&&i?i:void 0,...ve(f)}},A=at(g,e);return oe(A,g,{format:{max:s==="date"?v:g.max!=null&&ye(g.max)?me:pe,min:s==="date"?v:g.min!=null&&ye(g.min)?me:pe}})}return a===re.INVALID_CODED_VALUE?h.invalidCodedValue:a===Le.INVALID_TYPE?h.invalidType:a===V.TOO_SHORT?oe(h.tooShort,{min:n}):(V.TOO_LONG,null)},xt=t=>{var a;if(!t)return;const e=t.layer,i=e&&"geometryType"in e?e.geometryType:void 0,s=(a=t.geometry)==null?void 0:a.type;return s==="polyline"||i==="polyline"?"line":s==="mesh"||i==="mesh"||i==="multipatch"?"cube":s==="multipoint"||i==="multipoint"?"point":s||i||"table"},nt=t=>{var i;const e=[];if(t.formTemplate){const{description:s,title:a}=t.formTemplate;(i=t.fields)==null||i.forEach(n=>{const l=a&&Y(a,n.name),u=s&&Y(s,n.name);(l||u)&&e.push(n.name)})}return e};function Lt(t,e){var s;const i=e??("formTemplate"in t&&t.formTemplate);return i?(((s=i.elements)==null?void 0:s.filter(Te))??[]).some(({fieldName:a})=>!t.fieldsIndex.get(a)):!1}function Pt(t,e){return t==null||e.onValue!==t&&e.offValue!==t}function Ot(t,e){var i;switch(e.objectType){case"any":return!0;case"null":return t==null;case"code":return t===((i=e.codedValue)==null?void 0:i.code);case"range":return t!=null&&e.minValue!=null&&e.maxValue!=null&&+t>=e.minValue&&+t<=e.maxValue;default:return Ee(e.objectType),!1}}function Et(t,e,i){const s=Pe(t),a=s==null?void 0:s.find(l=>l.code===i);if(!a)return!1;const n=s==null?void 0:s.find(l=>l.code===e);return!Oe(a.defaultValues,n==null?void 0:n.defaultValues)&&Object.values(a.defaultValues).some(l=>l!=null)}const Z=100;let y=class extends De(Ve(fe)){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await Q(this._query()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await Q(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await Q(this._queryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryDebounced=U(this._queryController,Z),this._queryFeatureCountDebounced=U(this._queryFeatureCountController,Z),this._queryPageDebounced=U(this._queryPageController,Z),this._query=async()=>{const{_queryAbortController:e,relatedFeatures:i}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,i.destroyAll(),this.destroyed||i.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:e==null?void 0:e.signal}))))},this.addHandles([q(()=>{var e;return[this.displayCount,this.graphic,this.layer,(e=this.layer)==null?void 0:e.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]},()=>this._queryDebounced(),K),q(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),q(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(t){const{featuresPerPage:e,featureCount:i}=this,s=1,a=Math.ceil(i/e)||1;this._set("featurePage",Math.min(Math.max(t,s),a))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:t,relatedLayer:e}=this;return t&&(e!=null&&e.loaded)?t.map(i=>{const s=i.clone();return s.field=Ze(i.field,e),s}):t??[]}get supportsCacheHint(){var t,e,i;return!!((i=(e=(t=this.layer)==null?void 0:t.capabilities)==null?void 0:e.queryRelated)!=null&&i.supportsCacheHint)}get canLoad(){return!!this.map&&this.relationshipId!=null&&typeof this.objectId=="number"}get canQuery(){var e,i;const t=(i=(e=this.layer)==null?void 0:e.capabilities)==null?void 0:i.queryRelated;return!!(this.relatedLayer&&this.relationship&&this.relationshipId!=null&&this.objectId!=null&&(t!=null&&t.supportsCount)&&(t!=null&&t.supportsPagination))}get itemDescriptionFieldName(){var t;return((t=this.orderByFieldsFixedCasing[0])==null?void 0:t.field)||null}set displayCount(t){this._set("displayCount",Math.min(Math.max(t,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){var t,e;return(this.objectIdField&&((e=(t=this.graphic)==null?void 0:t.attributes)==null?void 0:e[this.objectIdField]))??null}get objectIdField(){var t;return((t=this.layer)==null?void 0:t.objectIdField)||null}get relatedFeatures(){return this._get("relatedFeatures")||new R}get relatedLayer(){const{layer:t,map:e,relationship:i}=this;return t!=null&&t.loaded&&e&&i?We(e,t,i)??null:null}get relationship(){var i;const{relationshipId:t,layer:e}=this;return t!=null?((i=e==null?void 0:e.relationships)==null?void 0:i.find(({id:s})=>s===t))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new R}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:i,canQuery:s,_loaded:a,canLoad:n}=this;return e||n&&!a?"loading":t||i?"querying":s?"ready":"disabled"}getRelatedFeatureByObjectId(t){return this.relatedFeatures.find(e=>e.getObjectId()===t)}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){var t;(t=this.relatedFeatureViewModels)==null||t.destroyAll()}async _queryFeatureCount(){const{layer:t,relatedLayer:e,relationshipId:i,objectId:s,_queryFeatureCountAbortController:a,canQuery:n,supportsCacheHint:l}=this;if(await(t==null?void 0:t.load()),await(e==null?void 0:e.load()),!n||!t||!e||s==null)return void this._set("featureCount",0);const u=e.createQuery(),{historicMoment:h,gdbVersion:f}=t,g=new de({cacheHint:l,gdbVersion:f,historicMoment:h,relationshipId:i,returnGeometry:!1,objectIds:[s],where:u.where??void 0}),v=await t.queryRelatedFeaturesCount(g,{signal:a==null?void 0:a.signal});this._set("featureCount",v[s]||0)}_sliceFeatures(t){const{showAllEnabled:e,displayCount:i}=this;return e?t:i?t.slice(0,i):[]}async _queryPage(){const{relatedFeatures:t,featurePage:e,showAllEnabled:i,_queryPageAbortController:s,featureCount:a}=this;!i||e<2||!a||t.addMany(await this._queryRelatedFeatures({signal:s==null?void 0:s.signal}))}async _queryRelatedFeatures(t){var X;const{orderByFieldsFixedCasing:e,showAllEnabled:i,featuresPerPage:s,displayCount:a,layer:n,relationshipId:l,featurePage:u,featureCount:h,relatedLayer:f,supportsCacheHint:g}=this,{canQuery:v,objectId:A}=this;if(!v||!n||!f||A==null)return[];const F=i?((u-1)*s+h)%h:0,k=i?s:a,I=f.objectIdField,S=[...e.map($=>$.field),...nt(f),I].filter(we),N=e.map($=>`${$.field} ${$.order}`),z=f.createQuery(),{historicMoment:H,gdbVersion:O}=n,E=new de({orderByFields:N,start:F,num:k,outFields:S,cacheHint:g,historicMoment:H,gdbVersion:O,relationshipId:l,returnGeometry:!1,objectIds:[A],where:z.where??void 0}),T=await n.queryRelatedFeatures(E,{signal:t==null?void 0:t.signal}),x=((X=T[A])==null?void 0:X.features)||[];return x.forEach($=>{$.sourceLayer=f,$.layer=f}),x}};r([o()],y.prototype,"_loaded",void 0),r([o()],y.prototype,"_queryAbortController",void 0),r([o()],y.prototype,"_queryPageAbortController",void 0),r([o()],y.prototype,"_queryFeatureCountAbortController",void 0),r([o({value:1})],y.prototype,"featurePage",null),r([o()],y.prototype,"featuresPerPage",void 0),r([o({readOnly:!0})],y.prototype,"orderByFieldsFixedCasing",null),r([o({readOnly:!0})],y.prototype,"supportsCacheHint",null),r([o({readOnly:!0})],y.prototype,"canLoad",null),r([o({readOnly:!0})],y.prototype,"canQuery",null),r([o()],y.prototype,"description",void 0),r([o({readOnly:!0})],y.prototype,"itemDescriptionFieldName",null),r([o({value:3})],y.prototype,"displayCount",null),r([o({type:be})],y.prototype,"graphic",void 0),r([o()],y.prototype,"layer",void 0),r([o()],y.prototype,"map",void 0),r([o({readOnly:!0})],y.prototype,"objectId",null),r([o({readOnly:!0})],y.prototype,"objectIdField",null),r([o()],y.prototype,"orderByFields",void 0),r([o({readOnly:!0})],y.prototype,"relatedFeatures",null),r([o({readOnly:!0})],y.prototype,"relatedLayer",null),r([o({readOnly:!0})],y.prototype,"relationship",null),r([o()],y.prototype,"featureCount",void 0),r([o({readOnly:!0})],y.prototype,"relatedFeatureViewModels",null),r([o()],y.prototype,"relationshipId",void 0),r([o()],y.prototype,"showAllEnabled",void 0),r([o()],y.prototype,"state",null),r([o()],y.prototype,"title",void 0),y=r([L("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],y);const Tt=y;let C=class extends Se.EventedAccessor{constructor(e){super(e),this.location=null,this.screenLocationEnabled=!1,this.view=null,this.addHandles([Ne(()=>{const i=this.screenLocationEnabled?this.view:null;return i?[i.size,i.type==="3d"?i.camera:i.viewpoint]:null},()=>this.notifyChange("screenLocation")),q(()=>this.screenLocation,(i,s)=>{i!=null&&s!=null&&this.emit("view-change")})])}destroy(){this.view=null}get screenLocation(){const{location:e,view:i,screenLocationEnabled:s}=this,a=i==null?void 0:i.spatialReference,n=a?ze(e,a).geometry:null;return s&&n&&(i!=null&&i.ready)?i.toScreen(n):null}};r([o()],C.prototype,"location",void 0),r([o()],C.prototype,"screenLocation",null),r([o()],C.prototype,"screenLocationEnabled",void 0),r([o()],C.prototype,"view",void 0),C=r([L("esri.widgets.support.AnchorElementViewModel")],C);const rt=C;let j=class extends rt{constructor(t){super(t),this.visible=!1}};r([o()],j.prototype,"visible",void 0),j=r([L("esri.widgets.Spinner.SpinnerViewModel")],j);const Ce=j,W="esri-spinner",J={base:W,spinnerStart:`${W}--start`,spinnerFinish:`${W}--finish`};let M=class extends _e{constructor(t,e){super(t,e),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Ce}initialize(){this.addHandles(q(()=>this.visible,t=>this._visibleChange(t)))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(t){this.viewModel.location=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}get visible(){return this.viewModel.visible}set visible(t){this.viewModel.visible=t}show(t){const{location:e,promise:i}=t??{};e&&(this.viewModel.location=e),this.visible=!0;const s=()=>this.hide();i&&i.catch(()=>{}).then(s)}hide(){this.visible=!1}render(){const{visible:t}=this,{screenLocation:e}=this.viewModel,i=!!e,s=t&&i,a=!t&&i,n={[J.spinnerStart]:s,[J.spinnerFinish]:a},l=this._getPositionStyles();return d("div",{class:this.classes(J.base,n),styles:l})}_visibleChange(t){if(t)return void(this.viewModel.screenLocationEnabled=!0);const e=He(this._animationDelay);this._animationPromise=e,e.catch(()=>{}).then(()=>{this._animationPromise===e&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:t,view:e}=this.viewModel;if(e==null||t==null)return{};const{padding:i}=e;return{left:t.x-i.left+"px",top:t.y-i.top+"px"}}};r([o()],M.prototype,"location",null),r([o()],M.prototype,"view",null),r([o({type:Ce})],M.prototype,"viewModel",void 0),r([o()],M.prototype,"visible",null),M=r([L("esri.widgets.Spinner")],M);const Rt=M;export{It as $,$t as A,xt as B,it as C,wt as E,Tt as F,qt as G,mt as I,Ot as J,Et as K,_t as N,yt as O,Ft as R,V as S,ft as T,At as U,vt as V,Lt as Y,Ct as Z,B as a,Ke as b,bt as c,Ie as g,Rt as h,$e as j,rt as l,Ce as p,kt as q,gt as v,Mt as w,Xe as x,Fe as y,Pt as z};
