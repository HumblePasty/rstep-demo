import{e as me}from"./deduplicate-CjrB8XiJ.js";import{H as F}from"./InterleavedLayout-BGJz6YRc.js";import{e as i}from"./VertexAttribute-Cq4MnHjR.js";import{t as Z}from"./glUtil-CAJRmga-.js";import{a5 as w,dR as ee,cU as Ie,cS as k,aq as oe,cE as H,cP as re,az as fe,aA as pe,c$ as Oe,c_ as Se,ar as de,cN as Ae,nA as Ee}from"./index-BeW5XHHa.js";import{s as j}from"./Normals-DwZKFj7v.js";const we=F().vec3f(i.POSITION).u16(i.COMPONENTINDEX).freeze(),Te=F().vec2u8(i.SIDENESS).freeze();Z(Te);const G=F().vec3f(i.POSITION0).vec3f(i.POSITION1).vec2i16(i.NORMALCOMPRESSED).u16(i.COMPONENTINDEX).u8(i.VARIANTOFFSET,{glNormalized:!0}).u8(i.VARIANTSTROKE).u8(i.VARIANTEXTENSION,{glNormalized:!0}).freeze(),J=F().vec3f(i.POSITION0).vec3f(i.POSITION1).vec2i16(i.NORMALCOMPRESSED).vec2i16(i.NORMAL2COMPRESSED).u16(i.COMPONENTINDEX).u8(i.VARIANTOFFSET,{glNormalized:!0}).u8(i.VARIANTSTROKE).u8(i.VARIANTEXTENSION,{glNormalized:!0}).freeze();i.POSITION0,i.POSITION1,i.COMPONENTINDEX,i.VARIANTOFFSET,i.VARIANTSTROKE,i.VARIANTEXTENSION,i.NORMALCOMPRESSED,i.NORMAL2COMPRESSED,i.SIDENESS;class ve{constructor(){this.position0=w(),this.position1=w(),this.faceNormal0=w(),this.faceNormal1=w(),this.componentIndex=0,this.cosAngle=0}}const W=-1;function ye(e,n,s){const r=e.vertices.position,c=e.vertices.componentIndex,f=m.position0,g=m.position1,N=m.faceNormal0,S=m.faceNormal1,{edges:a,normals:p}=$e(e),I=a.length/4,A=n.allocate(I);let $=0;const b=I,T=s==null?void 0:s.allocate(b);let z=0,t=0,o=0;B.length=0;for(let d=0;d<I;++d){const y=4*d;r.getVec(a.data[y],f),r.getVec(a.data[y+1],g);const x=B.pushNew();x.index=4*d,x.length=Ie(f,g)}B.sort((d,y)=>y.length-d.length);const u=new Array,l=new Array;B.forAll(({length:d,index:y})=>{const x=a.data[y],he=a.data[y+1],te=a.data[y+2],ne=a.data[y+3],se=ne===W;if(r.getVec(x,f),r.getVec(he,g),se){const E=3*te;k(N,p.data[E],p.data[E+1],p.data[E+2]),oe(S,N),m.componentIndex=c.get(x),m.cosAngle=H(N,S)}else{let E=3*te;if(k(N,p.data[E],p.data[E+1],p.data[E+2]),E=3*ne,k(S,p.data[E],p.data[E+1],p.data[E+2]),m.componentIndex=c.get(x),m.cosAngle=H(N,S),Re(m,De))return;m.cosAngle<-.9999&&oe(S,N)}t+=d,o++,se||Pe(m,Le)?(n.write(A,$++,m),u.push(d)):Me(m,ge)&&(T&&s&&s.write(T,z++,m),l.push(d))});const O=new Float32Array(u.reverse()),v=new Float32Array(l.reverse()),P=T&&s?{instancesData:T.slice(0,z),lodInfo:{lengths:v}}:void 0;return{regular:{instancesData:A.slice(0,$),lodInfo:{lengths:O}},silhouette:P,averageEdgeLength:t/o}}function Pe(e,n){return e.cosAngle<n}function Re(e,n){return e.cosAngle>n}function Me(e,n){const s=Oe(e.cosAngle);return Se(ae,e.position1,e.position0),s*(H(fe(xe,e.faceNormal0,e.faceNormal1),ae)>0?-1:1)>n}function $e(e){const n=e.faces.length/3,s=e.faces,r=e.neighbors,c=e.vertices.position;h.length=q.length=0;for(let f=0;f<n;f++){const g=3*f,N=r[g],S=r[g+1],a=r[g+2],p=s[g],I=s[g+1],A=s[g+2];c.getVec(p,V),c.getVec(I,_),c.getVec(A,U),re(_,_,V),re(U,U,V),fe(V,_,U),pe(V,V),q.pushArray(V),(N===W||p<I)&&(h.push(p),h.push(I),h.push(f),h.push(N)),(S===W||I<A)&&(h.push(I),h.push(A),h.push(f),h.push(S)),(a===W||A<p)&&(h.push(A),h.push(p),h.push(f),h.push(a))}return{edges:h,normals:q}}class Ve{constructor(){this.index=0,this.length=0}}const B=new ee({allocator:e=>e||new Ve,deallocator:null}),h=new ee({deallocator:null}),q=new ee({deallocator:null}),m=new ve,xe=w(),ae=w(),V=w(),_=w(),U=w(),ge=de(4),De=Math.cos(ge),Ce=de(35),Le=Math.cos(Ce);function ce(e,n,s){const r=n/3,c=new Uint32Array(s+1),f=new Uint32Array(s+1),g=(t,o)=>{t<o?c[t+1]++:f[o+1]++};for(let t=0;t<r;t++){const o=e[3*t],u=e[3*t+1],l=e[3*t+2];g(o,u),g(u,l),g(l,o)}let N=0,S=0;for(let t=0;t<s;t++){const o=c[t+1],u=f[t+1];c[t+1]=N,f[t+1]=S,N+=o,S+=u}const a=new Uint32Array(6*r),p=c[s],I=(t,o,u)=>{if(t<o){const l=c[t+1]++;a[2*l]=o,a[2*l+1]=u}else{const l=f[o+1]++;a[2*p+2*l]=t,a[2*p+2*l+1]=u}};for(let t=0;t<r;t++){const o=e[3*t],u=e[3*t+1],l=e[3*t+2];I(o,u,t),I(u,l,t),I(l,o,t)}const A=(t,o)=>{const u=2*t,l=o-t;for(let O=1;O<l;O++){const v=a[u+2*O],P=a[u+2*O+1];let d=O-1;for(;d>=0&&a[u+2*d]>v;d--)a[u+2*d+2]=a[u+2*d],a[u+2*d+3]=a[u+2*d+1];a[u+2*d+2]=v,a[u+2*d+3]=P}};for(let t=0;t<s;t++)A(c[t],c[t+1]),A(p+f[t],p+f[t+1]);const $=new Int32Array(3*r),b=(t,o)=>t===e[3*o]?0:t===e[3*o+1]?1:t===e[3*o+2]?2:-1,T=(t,o)=>{const u=b(t,o);$[3*o+u]=-1},z=(t,o,u,l)=>{const O=b(t,o);$[3*o+O]=l;const v=b(u,l);$[3*l+v]=o};for(let t=0;t<s;t++){let o=c[t];const u=c[t+1];let l=f[t];const O=f[t+1];for(;o<u&&l<O;){const v=a[2*o],P=a[2*p+2*l];v===P?(z(t,a[2*o+1],P,a[2*p+2*l+1]),o++,l++):v<P?(T(t,a[2*o+1]),o++):(T(P,a[2*p+2*l+1]),l++)}for(;o<u;)T(t,a[2*o+1]),o++;for(;l<O;)T(a[2*p+2*l],a[2*p+2*l+1]),l++}return $}const K=.7;let Ne=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?be:Fe}write(n,s,r){X.seed=this._edgeHashFunction(r);const c=X.getIntRange(0,255),f=X.getIntRange(0,this.settings.variants-1),g=X.getFloat(),N=255*(.5*ze(-(1-Math.min(g/K,1))+Math.max(0,g-K)/(1-K),1.2)+.5);n.position0.setVec(s,r.position0),n.position1.setVec(s,r.position1),n.componentIndex.set(s,r.componentIndex),n.variantOffset.set(s,c),n.variantStroke.set(s,f),n.variantExtension.set(s,N)}};const R=new Float32Array(6),M=new Uint32Array(R.buffer),L=new Uint32Array(1);function Fe(e){return R[0]=e.position0[0],R[1]=e.position0[1],R[2]=e.position0[2],R[3]=e.position1[0],R[4]=e.position1[1],R[5]=e.position1[2],L[0]=31*(31*(31*(31*(31*(166811+M[0])+M[1])+M[2])+M[3])+M[4])+M[5],L[0]}function be(e){const n=R;n[0]=D(e.position0[0]),n[1]=D(e.position0[1]),n[2]=D(e.position0[2]),n[3]=D(e.position1[0]),n[4]=D(e.position1[1]),n[5]=D(e.position1[2]),L[0]=5381;for(let s=0;s<M.length;s++)L[0]=31*L[0]+M[s];return L[0]}const ie=1e4;function D(e){return Math.round(e*ie)/ie}function ze(e,n){return Math.abs(e)**n*Math.sign(e)}class Q{constructor(){this._commonWriter=new Ne}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return G.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),Ae(C,r.faceNormal0,r.faceNormal1),pe(C,C);const{typedBuffer:c,typedBufferStride:f}=n.normalCompressed;j(c,s,C[0],C[1],C[2],f)}}Q.Layout=G,Q.glLayout=Z(G,1);class Y{constructor(){this._commonWriter=new Ne}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return J.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:c,typedBufferStride:f}=n.normalCompressed;j(c,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],f)}{const{typedBuffer:c,typedBufferStride:f}=n.normal2Compressed;j(c,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],f)}}}Y.Layout=J,Y.glLayout=Z(J,1);const C=w(),X=new Ee;function je(e){const n=Be(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return le.updateSettings(e.writerSettings),ue.updateSettings(e.writerSettings),ye(n,le,ue)}function Be(e,n,s,r){if(n){const g=ce(s,r,e.count);return new _e(s,r,g,e)}const c=me(e.buffer,e.stride/4,{originalIndices:s}),f=ce(c.indices,r,c.uniqueCount);return{faces:c.indices,facesLength:c.indices.length,neighbors:f,vertices:we.createView(c.buffer)}}class _e{constructor(n,s,r,c){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=c}}const le=new Q,ue=new Y,Ge=F().vec3f(i.POSITION0).vec3f(i.POSITION1),Je=F().vec3f(i.POSITION0).vec3f(i.POSITION1).u16(i.COMPONENTINDEX);export{we as E,Ge as d,je as f,Je as m,ye as p,Be as u};
